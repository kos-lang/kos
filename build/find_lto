#!/bin/sh

# Copyright (c) 2014-2017 Chris Dragan
#
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to
# deal in the Software without restriction, including without limitation the
# rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
# sell copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in
# all copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
# FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
# IN THE SOFTWARE.

set -e

type_wrap()
{
    type "$1" 2>&1 >/dev/null
}

have()
{
    # WAR older bash bug -- type command prints error even if command not found
    type_wrap "$1" 2>&1 >/dev/null
}

if have "$2-$1"; then
    echo "$2-$1"
    exit 0
fi

have "$2" || exit 1
have gcc  || exit 1

CC_VER=$("$2" -v 2>&1 | grep "^gcc version ")
GCC_VER=$(gcc -v 2>&1 | grep "^gcc version ")

[ "$CC_VER" = "$GCC_VER" ] || exit 1

GCC_VER=$(echo "$GCC_VER" | sed 's/^gcc version // ; s/ .*//')
MAJOR=$(echo "$GCC_VER" | sed 's/\..*//')
MINOR=$(echo "$GCC_VER" | sed 's/^.\.// ; s/\..*//')

# GCC 4.8 and up supports LTO
[ "$MAJOR" = "2" -o "$MAJOR" = "3" ] && exit 1
[ "$MAJOR" != "4" -o $MINOR -ge 8 ] || exit 1

if have "gcc-$1"; then
    echo "gcc-$1"
    exit 0
fi

if have "gcc-$1-$MAJOR"; then
    echo "gcc-$1-$MAJOR"
    exit 0
fi

exit 1
